options:
  defaultLogsBucketBehavior: REGIONAL_USER_OWNED_BUCKET

availableSecrets:
  secretManager:
    - versionName: projects/937418172711/secrets/sonar-token/versions/latest
      env: 'SONAR_TOKEN'

steps:
  - id: Run Maven build
    name: gcr.io/cloud-builders/mvn
    entrypoint: bash
    args:
      - -c
      - |
        echo " Running Maven build..."
        mvn clean install
        echo " Build complete!"

  - id: Sonar scan
    name: ${_SONAR_REPO_PATH}/sonar:${_IMAGE_TAG}
    secretEnv:
      - SONAR_TOKEN
    dir: "/workspace"
    args:
      - -Dproject.settings=/workspace/sonar-project.properties

  - id: Build Docker image
    name: gcr.io/cloud-builders/docker
    args:
      - build
      - -t
      - ${_GAN_WEB_REPO_PATH}${_SERVICE_NAME}:${_IMAGE_TAG}
      - .

  - id: Push Docker image
    name: gcr.io/cloud-builders/docker
    args:
      - push
      - ${_GAN_WEB_REPO_PATH}${_SERVICE_NAME}:${_IMAGE_TAG}
  
  - id: "Deploy Service To Cloud Run"
    name: ${_CLOUD_RUN_REPO_PATH}/project-configurator:${_IMAGE_TAG}
    args:
      - service
      - --action
      - deploy
      

